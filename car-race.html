<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Road Dodge</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; background: #f7fafc; }
    .game-wrap { max-width: 420px; margin: 24px auto; padding: 12px; background: #fff; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
    .hud { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .hud .score { font-weight: 700; }
    .btn { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; background: #0ea5e9; color: #fff; font-weight: 600; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .board { width: 360px; height: 560px; margin: 0 auto; background: #2b2b2b; border: 8px solid #555; border-radius: 12px; }
    .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px; }
    .controls .ctrl { padding: 10px; background: #e2e8f0; border-radius: 8px; text-align: center; font-weight: 600; cursor: pointer; }
    .controls .ctrl:active { background: #cbd5e1; }
    .msg { text-align: center; margin-top: 10px; color: #334155; }
    canvas { display: block; }
  </style>
  </head>
<body>
  <div class="game-wrap">
    <div class="hud">
      <div class="score">Score: <span id="score">0</span></div>
      <button id="startBtn" class="btn">Start</button>
    </div>
    <div class="board">
      <canvas id="game" width="360" height="560"></canvas>
    </div>
    <div class="controls">
      <div class="ctrl" id="leftBtn">◀ Left</div>
      <div class="ctrl" id="boostBtn">▲ Boost</div>
      <div class="ctrl" id="rightBtn">Right ▶</div>
    </div>
    <div class="msg" id="msg">Switch lanes and dodge cars. Arrow keys or A/D.</div>
  </div>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const msgEl = document.getElementById('msg');
    const startBtn = document.getElementById('startBtn');
    const leftBtn = document.getElementById('leftBtn');
    const rightBtn = document.getElementById('rightBtn');
    const boostBtn = document.getElementById('boostBtn');

    // Dimensions and lanes
    const W = canvas.width, H = canvas.height;
    const lanesX = [60, 180, 300];
    const carW = 36, carH = 60;
    const obsW = 36, obsH = 60;
    const stripeH = 30;

    // State
    let running = false;
    let score = 0;
    let speed = 3.2;
    let playerLane = 1;
    let playerY = H - carH - 12;
    let stripesOffset = 0;
    let obstacles = [];
    let spawnTimer = 0;
    let rafId = null;
    let lastTs = 0;

    function awardPoints(points) {
      const user = localStorage.getItem('authUser') || localStorage.getItem('currentUser') || localStorage.getItem('username');
      if (user) {
        const key = 'points:' + user;
        const cur = parseInt(localStorage.getItem(key) || '0', 10);
        localStorage.setItem(key, String(cur + points));
      }
    }

    function reset() {
      running = false;
      score = 0;
      speed = 3.2;
      playerLane = 1;
      playerY = H - carH - 12;
      stripesOffset = 0;
      obstacles = [];
      spawnTimer = 0;
      lastTs = 0;
      scoreEl.textContent = '0';
      msgEl.textContent = 'Switch lanes and dodge cars. Arrow keys or A/D.';
    }

    function drawBackground() {
      ctx.fillStyle = '#2b2b2b';
      ctx.fillRect(0, 0, W, H);
      ctx.fillStyle = '#555';
      ctx.fillRect(0, 0, 10, H);
      ctx.fillRect(W - 10, 0, 10, H);
      ctx.fillStyle = 'rgba(255,255,255,0.85)';
      stripesOffset = (stripesOffset + speed) % (stripeH * 2);
      for (const lx of [120, 240]) {
        for (let y = -stripeH; y < H + stripeH; y += stripeH * 2) {
          ctx.fillRect(lx, y + stripesOffset, 2, stripeH);
        }
      }
    }

    function drawPlayer() {
      const px = lanesX[playerLane] - carW / 2;
      ctx.fillStyle = '#22c55e';
      ctx.fillRect(px, playerY, carW, carH);
      ctx.fillStyle = '#0ea5e9';
      ctx.fillRect(px + 6, playerY + 10, carW - 12, 16);
    }

    function drawObstacles() {
      for (const o of obstacles) {
        ctx.fillStyle = '#ef4444';
        ctx.fillRect(o.x, o.y, obsW, obsH);
        ctx.fillStyle = '#fde047';
        ctx.fillRect(o.x + 8, o.y + obsH - 8, 6, 6);
        ctx.fillRect(o.x + obsW - 14, o.y + obsH - 8, 6, 6);
      }
    }

    function movePlayer(dx) { playerLane = Math.max(0, Math.min(2, playerLane + dx)); }

    function spawnObstacle() {
      const lane = Math.floor(Math.random() * 3);
      const ox = lanesX[lane] - obsW / 2;
      obstacles.push({ lane, x: ox, y: -obsH, s: speed + Math.random() * 1.8 });
    }

    function update(dt) {
      for (const o of obstacles) o.y += o.s;
      obstacles = obstacles.filter(o => {
        if (o.y > H) { score += 1; scoreEl.textContent = String(score); return false; }
        return true;
      });
      spawnTimer += dt;
      if (spawnTimer > 900) { spawnObstacle(); spawnTimer = 0; }
      speed = Math.min(7.5, speed + 0.002);
      const px = lanesX[playerLane] - carW / 2;
      for (const o of obstacles) {
        const hit = px < o.x + obsW && px + carW > o.x && playerY < o.y + obsH && playerY + carH > o.y;
        if (hit) { end(); break; }
      }
    }

    function loop(ts) {
      if (!running) return;
      const dt = lastTs ? ts - lastTs : 16;
      lastTs = ts;
      ctx.clearRect(0, 0, W, H);
      drawBackground();
      update(dt);
      drawObstacles();
      drawPlayer();
      rafId = requestAnimationFrame(loop);
    }

    function start() {
      reset();
      running = true;
      startBtn.disabled = true;
      msgEl.textContent = 'Racing... Use ◀ ▶ or A/D to switch lanes';
      rafId = requestAnimationFrame(loop);
    }

    function end() {
      running = false;
      if (rafId) cancelAnimationFrame(rafId);
      startBtn.disabled = false;
      const points = Math.max(1, score);
      awardPoints(points);
      msgEl.textContent = `Game Over! Score: ${score}. +${points} points awarded.`;
      alert(`Crash! Your score: ${score}.\n${points} points added to your account if logged in.`);
    }

    // Controls
    document.addEventListener('keydown', (e) => {
      if (!running) return;
      if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') movePlayer(-1);
      if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') movePlayer(1);
      if (e.key === 'ArrowUp' || e.key.toLowerCase() === 'w') speed = Math.min(9, speed + 0.8);
    });
    leftBtn.addEventListener('click', () => running && movePlayer(-1));
    rightBtn.addEventListener('click', () => running && movePlayer(1));
    boostBtn.addEventListener('click', () => { speed = Math.min(9, speed + 0.8); });
    startBtn.addEventListener('click', start);

    // Initial paint
    reset();
    drawBackground();
    drawPlayer();
  </script>
</body>
</html>
